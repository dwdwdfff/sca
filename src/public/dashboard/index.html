<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم WhatsApp Sender</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #128C7E;
            --secondary-color: #075E54;
            --accent-color: #25D366;
            --light-color: #DCF8C6;
            --dark-color: #34495e;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 0;
            margin-bottom: 5px;
        }
        
        .sidebar .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link.active {
            color: white;
            background-color: var(--primary-color);
        }
        
        .main-content {
            margin-right: 250px;
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-success:hover {
            background-color: #1da856;
            border-color: #1da856;
        }
        
        .session-card {
            cursor: pointer;
        }
        
        .session-card.selected {
            border: 2px solid var(--accent-color);
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        
        .status-connected {
            background-color: var(--success-color);
        }
        
        .status-disconnected {
            background-color: var(--danger-color);
        }
        
        .status-waiting {
            background-color: var(--warning-color);
        }
        
        .chart-container {
            height: 300px;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            padding: 10px 15px;
        }
        
        .logo i {
            color: var(--accent-color);
        }
        
        .session-icon {
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #qrCodeModal .modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #qrCodeImage {
            margin: 20px auto;
            max-width: 256px;
            max-height: 256px;
        }
        
        .progress {
            height: 10px;
            margin-top: 10px;
        }
        
        .progress-bar {
            background-color: var(--accent-color);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="logo">
                    <i class="bi bi-whatsapp"></i> WhatsApp Sender
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard-section" data-section="dashboard-section">
                            <i class="bi bi-speedometer2"></i> لوحة التحكم
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#sessions-section" data-section="sessions-section">
                            <i class="bi bi-phone"></i> الجلسات
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#messaging-section" data-section="messaging-section">
                            <i class="bi bi-chat-dots"></i> إرسال الرسائل
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#bulk-section" data-section="bulk-section">
                            <i class="bi bi-file-earmark-spreadsheet"></i> إرسال بالجملة
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#settings-section" data-section="settings-section">
                            <i class="bi bi-gear"></i> الإعدادات
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 ms-sm-auto main-content">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section active">
                    <h2 class="mb-4">لوحة التحكم</h2>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-phone-fill session-icon"></i>
                                    <h5 class="card-title mt-3">الجلسات النشطة</h5>
                                    <h2 id="active-sessions-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-chat-dots-fill session-icon"></i>
                                    <h5 class="card-title mt-3">الرسائل المرسلة</h5>
                                    <h2 id="total-messages-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-hourglass-split session-icon"></i>
                                    <h5 class="card-title mt-3">الرسائل في الانتظار</h5>
                                    <h2 id="pending-messages-count">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    حالة الجلسات
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="sessions-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    إحصائيات الرسائل
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="messages-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    آخر الأنشطة
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="activity-list">
                                        <!-- Activities will be added here dynamically -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sessions Section -->
                <div id="sessions-section" class="section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>إدارة الجلسات</h2>
                        <button class="btn btn-primary" id="create-session-btn">
                            <i class="bi bi-plus-circle"></i> جلسة جديدة
                        </button>
                    </div>
                    
                    <div class="row" id="sessions-container">
                        <!-- Sessions will be added here dynamically -->
                    </div>
                </div>
                
                <!-- Messaging Section -->
                <div id="messaging-section" class="section d-none">
                    <h2 class="mb-4">إرسال الرسائل</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            إرسال رسالة جديدة
                        </div>
                        <div class="card-body">
                            <form id="send-message-form">
                                <div class="mb-3">
                                    <label for="session-select" class="form-label">اختر الجلسة</label>
                                    <select class="form-select" id="session-select" required>
                                        <option value="">اختر جلسة...</option>
                                        <!-- Sessions will be added here dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="phone-number" class="form-label">رقم الهاتف (مع رمز الدولة)</label>
                                    <input type="text" class="form-control" id="phone-number" placeholder="مثال: +201234567890" required>
                                </div>
                                <div class="mb-3">
                                    <label for="message-text" class="form-label">نص الرسالة</label>
                                    <textarea class="form-control" id="message-text" rows="5" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary" id="send-message-btn">
                                    <i class="bi bi-send"></i> إرسال الرسالة
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Messaging Section -->
                <div id="bulk-section" class="section d-none">
                    <h2 class="mb-4">إرسال رسائل بالجملة</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            رفع ملف إكسل
                        </div>
                        <div class="card-body">
                            <form id="excel-upload-form">
                                <div class="mb-3">
                                    <label for="session-select-bulk" class="form-label">اختر الجلسة</label>
                                    <select class="form-select" id="session-select-bulk" required>
                                        <option value="">اختر جلسة...</option>
                                        <!-- Sessions will be added here dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="excel-file" class="form-label">ملف الإكسل</label>
                                    <input class="form-control" type="file" id="excel-file" accept=".xlsx,.xls" required>
                                    <div class="form-text">يجب أن يحتوي الملف على عمود يحتوي على أرقام الهواتف.</div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="parse-excel-btn">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> تحليل الملف
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card mt-4 d-none" id="numbers-card">
                        <div class="card-header">
                            الأرقام المستخرجة
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="extracted-numbers" class="form-label">الأرقام المستخرجة من الملف</label>
                                <textarea class="form-control" id="extracted-numbers" rows="5" readonly></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="bulk-message-text" class="form-label">نص الرسالة</label>
                                <textarea class="form-control" id="bulk-message-text" rows="5" required></textarea>
                            </div>
                            <button type="button" class="btn btn-success" id="send-bulk-btn">
                                <i class="bi bi-send"></i> إرسال للجميع
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mt-4 d-none" id="progress-card">
                        <div class="card-header">
                            تقدم الإرسال
                        </div>
                        <div class="card-body">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span id="sent-count">0</span>
                                <span id="total-count">0</span>
                            </div>
                            <div class="alert alert-info mt-3">
                                جاري إرسال الرسائل... يرجى عدم إغلاق هذه الصفحة.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div id="settings-section" class="section d-none">
                    <h2 class="mb-4">الإعدادات</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            إعدادات عامة
                        </div>
                        <div class="card-body">
                            <form id="settings-form">
                                <div class="mb-3">
                                    <label for="delay-between-messages" class="form-label">التأخير بين الرسائل (بالثواني)</label>
                                    <input type="number" class="form-control" id="delay-between-messages" min="1" max="10" value="1">
                                    <div class="form-text">زيادة التأخير قد تساعد في تجنب حظر الحساب.</div>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="auto-reconnect">
                                    <label class="form-check-label" for="auto-reconnect">إعادة الاتصال تلقائيًا عند الانقطاع</label>
                                </div>
                                <button type="submit" class="btn btn-primary">حفظ الإعدادات</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Session Modal -->
    <div class="modal fade" id="createSessionModal" tabindex="-1" aria-labelledby="createSessionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createSessionModalLabel">إنشاء جلسة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-session-form">
                        <div class="mb-3">
                            <label for="session-name" class="form-label">اسم الجلسة</label>
                            <input type="text" class="form-control" id="session-name" required>
                            <div class="form-text">استخدم اسمًا وصفيًا للجلسة (مثل: هاتف_العمل، هاتف_شخصي)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="confirm-create-session">إنشاء</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- QR Code Modal -->
    <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrCodeModalLabel">مسح رمز QR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p>افتح WhatsApp على هاتفك وامسح رمز QR للاتصال</p>
                    <div id="qrCodeImage"></div>
                    <div id="qrStatus">جاري تحميل رمز QR...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <a href="#" class="btn btn-primary" id="open-qr-page" target="_blank">فتح في صفحة منفصلة</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success/Error Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">إشعار</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                تمت العملية بنجاح
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script>
        // API Base URL
        const API_BASE_URL = '';
        
        // Global variables
        let sessions = [];
        let selectedSessionId = null;
        let extractedNumbers = [];
        let sessionsChart = null;
        let messagesChart = null;
        
        // DOM Elements
        const sessionContainer = document.getElementById('sessions-container');
        const sessionSelect = document.getElementById('session-select');
        const sessionSelectBulk = document.getElementById('session-select-bulk');
        const extractedNumbersTextarea = document.getElementById('extracted-numbers');
        const numbersCard = document.getElementById('numbers-card');
        const progressCard = document.getElementById('progress-card');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const qrStatus = document.getElementById('qrStatus');
        const openQrPage = document.getElementById('open-qr-page');
        
        // Initialize Bootstrap components
        const createSessionModal = new bootstrap.Modal(document.getElementById('createSessionModal'));
        const qrCodeModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
        const toast = new bootstrap.Toast(document.getElementById('toast'));
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Load sessions
            loadSessions();
            
            // Initialize charts
            initCharts();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up navigation
            setupNavigation();
            
            // Update dashboard periodically
            setInterval(updateDashboard, 5000);
        });
        
        // Load sessions from API
        function loadSessions() {
            fetch(`${API_BASE_URL}/api/sessions`)
                .then(response => response.json())
                .then(data => {
                    sessions = data.sessions;
                    updateSessionsUI();
                    updateSessionSelects();
                    updateDashboardCounts();
                    addActivity('تم تحميل الجلسات');
                })
                .catch(error => {
                    console.error('Error loading sessions:', error);
                    showToast('خطأ', 'فشل في تحميل الجلسات', 'error');
                });
        }
        
        // Update sessions UI
        function updateSessionsUI() {
            sessionContainer.innerHTML = '';
            
            if (sessions.length === 0) {
                sessionContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            لا توجد جلسات. انقر على "جلسة جديدة" لإنشاء جلسة.
                        </div>
                    </div>
                `;
                return;
            }
            
            sessions.forEach(session => {
                const statusClass = getStatusClass(session.status);
                const statusText = getStatusText(session.status);
                
                const sessionCard = document.createElement('div');
                sessionCard.className = `col-md-4 mb-4`;
                sessionCard.innerHTML = `
                    <div class="card session-card" data-session-id="${session.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">${session.name || session.id}</h5>
                                <span class="badge status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <p class="card-text">
                                <small class="text-muted">تم الإنشاء: ${formatDate(session.createdAt)}</small>
                            </p>
                            <p class="card-text">
                                الرسائل المرسلة: ${session.messagesSent || 0}
                            </p>
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-sm btn-primary qr-btn" data-session-id="${session.id}">
                                    <i class="bi bi-qr-code"></i> رمز QR
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" data-session-id="${session.id}">
                                    <i class="bi bi-trash"></i> حذف
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                sessionContainer.appendChild(sessionCard);
                
                // Add event listeners to the session card
                const card = sessionCard.querySelector('.session-card');
                card.addEventListener('click', () => selectSession(session.id));
                
                // Add event listeners to buttons
                const qrBtn = sessionCard.querySelector('.qr-btn');
                qrBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showQRCode(session.id);
                });
                
                const deleteBtn = sessionCard.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSession(session.id);
                });
            });
        }
        
        // Update session select dropdowns
        function updateSessionSelects() {
            // Clear existing options
            sessionSelect.innerHTML = '<option value="">اختر جلسة...</option>';
            sessionSelectBulk.innerHTML = '<option value="">اختر جلسة...</option>';
            
            // Add connected sessions
            const connectedSessions = sessions.filter(session => session.status === 'CONNECTED');
            
            connectedSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = session.name || session.id;
                
                sessionSelect.appendChild(option.cloneNode(true));
                sessionSelectBulk.appendChild(option);
            });
            
            if (connectedSessions.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'لا توجد جلسات متصلة';
                
                sessionSelect.appendChild(option.cloneNode(true));
                sessionSelectBulk.appendChild(option);
            }
        }
        
        // Update dashboard counts
        function updateDashboardCounts() {
            const activeSessionsCount = sessions.filter(session => session.status === 'CONNECTED').length;
            const totalMessagesCount = sessions.reduce((total, session) => total + (session.messagesSent || 0), 0);
            const pendingMessagesCount = sessions.reduce((total, session) => total + (session.queueLength || 0), 0);
            
            document.getElementById('active-sessions-count').textContent = activeSessionsCount;
            document.getElementById('total-messages-count').textContent = totalMessagesCount;
            document.getElementById('pending-messages-count').textContent = pendingMessagesCount;
            
            updateCharts();
        }
        
        // Initialize charts
        function initCharts() {
            const sessionsCtx = document.getElementById('sessions-chart').getContext('2d');
            sessionsChart = new Chart(sessionsCtx, {
                type: 'pie',
                data: {
                    labels: ['متصل', 'غير متصل', 'في انتظار المسح'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            '#27ae60',
                            '#e74c3c',
                            '#f39c12'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            const messagesCtx = document.getElementById('messages-chart').getContext('2d');
            messagesChart = new Chart(messagesCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'الرسائل المرسلة',
                        data: [],
                        backgroundColor: '#128C7E'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Update charts with current data
        function updateCharts() {
            if (!sessionsChart || !messagesChart) return;
            
            // Update sessions chart
            const connected = sessions.filter(session => session.status === 'CONNECTED').length;
            const disconnected = sessions.filter(session => session.status === 'DISCONNECTED' || session.status === 'LOGGED_OUT').length;
            const waiting = sessions.filter(session => session.status === 'WAITING_FOR_SCAN' || session.status === 'INITIALIZING').length;
            
            sessionsChart.data.datasets[0].data = [connected, disconnected, waiting];
            sessionsChart.update();
            
            // Update messages chart
            const sessionNames = sessions.map(session => session.name || session.id);
            const messagesCounts = sessions.map(session => session.messagesSent || 0);
            
            messagesChart.data.labels = sessionNames;
            messagesChart.data.datasets[0].data = messagesCounts;
            messagesChart.update();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Create session button
            document.getElementById('create-session-btn').addEventListener('click', () => {
                createSessionModal.show();
            });
            
            // Confirm create session button
            document.getElementById('confirm-create-session').addEventListener('click', createSession);
            
            // Send message form
            document.getElementById('send-message-form').addEventListener('submit', (e) => {
                e.preventDefault();
                sendMessage();
            });
            
            // Excel upload form
            document.getElementById('excel-upload-form').addEventListener('submit', (e) => {
                e.preventDefault();
                parseExcelFile();
            });
            
            // Send bulk messages button
            document.getElementById('send-bulk-btn').addEventListener('click', sendBulkMessages);
            
            // Settings form
            document.getElementById('settings-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveSettings();
            });
        }
        
        // Set up navigation
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    link.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.add('d-none');
                    });
                    
                    // Show selected section
                    const sectionId = link.getAttribute('data-section');
                    document.getElementById(sectionId).classList.remove('d-none');
                });
            });
        }
        
        // Create a new session
        function createSession() {
            const sessionName = document.getElementById('session-name').value.trim();
            
            if (!sessionName) {
                showToast('خطأ', 'يرجى إدخال اسم للجلسة', 'error');
                return;
            }
            
            fetch(`${API_BASE_URL}/api/sessions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: sessionName })
            })
            .then(response => response.json())
            .then(data => {
                createSessionModal.hide();
                document.getElementById('session-name').value = '';
                
                showToast('نجاح', `تم إنشاء الجلسة ${data.id} بنجاح`, 'success');
                addActivity(`تم إنشاء جلسة جديدة: ${data.id}`);
                
                // Reload sessions
                loadSessions();
                
                // Show QR code for the new session
                setTimeout(() => {
                    showQRCode(data.id);
                }, 1000);
            })
            .catch(error => {
                console.error('Error creating session:', error);
                showToast('خطأ', 'فشل في إنشاء الجلسة', 'error');
            });
        }
        
        // Delete a session
        function deleteSession(sessionId) {
            if (!confirm(`هل أنت متأكد من حذف الجلسة ${sessionId}؟`)) {
                return;
            }
            
            fetch(`${API_BASE_URL}/api/sessions/${sessionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                showToast('نجاح', data.message, 'success');
                addActivity(`تم حذف الجلسة: ${sessionId}`);
                
                // Reload sessions
                loadSessions();
            })
            .catch(error => {
                console.error('Error deleting session:', error);
                showToast('خطأ', 'فشل في حذف الجلسة', 'error');
            });
        }
        
        // Select a session
        function selectSession(sessionId) {
            selectedSessionId = sessionId;
            
            // Update UI to show selected session
            document.querySelectorAll('.session-card').forEach(card => {
                card.classList.remove('selected');
                
                if (card.getAttribute('data-session-id') === sessionId) {
                    card.classList.add('selected');
                }
            });
            
            // Update session selects
            sessionSelect.value = sessionId;
            sessionSelectBulk.value = sessionId;
        }
        
        // Show QR code for a session
        function showQRCode(sessionId) {
            qrCodeImage.innerHTML = '';
            qrStatus.textContent = 'جاري تحميل رمز QR...';
            openQrPage.href = `/qr/${sessionId}`;
            
            qrCodeModal.show();
            
            fetchQRCode();
            
            function fetchQRCode() {
                fetch(`${API_BASE_URL}/api/sessions/${sessionId}/qr`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'connected') {
                            qrStatus.textContent = 'متصل بالفعل بـ WhatsApp!';
                            return;
                        }
                        
                        if (data.status === 'pending') {
                            setTimeout(fetchQRCode, 1000);
                            return;
                        }
                        
                        if (data.qrCode) {
                            qrCodeImage.innerHTML = '';
                            QRCode.toCanvas(qrCodeImage, data.qrCode, { width: 256 }, (error) => {
                                if (error) console.error(error);
                            });
                            qrStatus.textContent = 'امسح رمز QR باستخدام WhatsApp للاتصال';
                            
                            // Check status periodically
                            checkQRStatus();
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching QR code:', error);
                        qrStatus.textContent = 'خطأ في تحميل رمز QR. يرجى المحاولة مرة أخرى.';
                    });
            }
            
            function checkQRStatus() {
                fetch(`${API_BASE_URL}/api/sessions/${sessionId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'CONNECTED') {
                            qrStatus.textContent = 'تم الاتصال بنجاح!';
                            loadSessions(); // Reload sessions to update UI
                            setTimeout(() => {
                                qrCodeModal.hide();
                            }, 2000);
                            return;
                        }
                        
                        setTimeout(checkQRStatus, 2000);
                    })
                    .catch(error => {
                        console.error('Error checking status:', error);
                    });
            }
        }
        
        // Send a message
        function sendMessage() {
            const sessionId = sessionSelect.value;
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const messageText = document.getElementById('message-text').value.trim();
            
            if (!sessionId || !phoneNumber || !messageText) {
                showToast('خطأ', 'يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('send-message-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading-spinner"></span> جاري الإرسال...';
            
            fetch(`${API_BASE_URL}/api/sessions/${sessionId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    number: phoneNumber,
                    message: messageText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('نجاح', 'تم إرسال الرسالة بنجاح', 'success');
                    addActivity(`تم إرسال رسالة إلى ${phoneNumber}`);
                    
                    // Clear form
                    document.getElementById('phone-number').value = '';
                    document.getElementById('message-text').value = '';
                    
                    // Update dashboard
                    loadSessions();
                } else {
                    showToast('خطأ', data.error || 'فشل في إرسال الرسالة', 'error');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                showToast('خطأ', 'فشل في إرسال الرسالة', 'error');
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="bi bi-send"></i> إرسال الرسالة';
            });
        }
        
        // Parse Excel file
        function parseExcelFile() {
            const fileInput = document.getElementById('excel-file');
            const sessionId = sessionSelectBulk.value;
            
            if (!sessionId) {
                showToast('خطأ', 'يرجى اختيار جلسة', 'error');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('خطأ', 'يرجى اختيار ملف إكسل', 'error');
                return;
            }
            
            const parseBtn = document.getElementById('parse-excel-btn');
            parseBtn.disabled = true;
            parseBtn.innerHTML = '<span class="loading-spinner"></span> جاري التحليل...';
            
            const formData = new FormData();
            formData.append('excelFile', fileInput.files[0]);
            
            fetch(`${API_BASE_URL}/api/excel/parse`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    extractedNumbers = data.phoneNumbers;
                    
                    // Show extracted numbers
                    extractedNumbersTextarea.value = extractedNumbers.join('\n');
                    numbersCard.classList.remove('d-none');
                    
                    showToast('نجاح', `تم استخراج ${extractedNumbers.length} رقم من الملف`, 'success');
                    addActivity(`تم تحليل ملف إكسل واستخراج ${extractedNumbers.length} رقم`);
                } else {
                    showToast('خطأ', data.error || 'فشل في تحليل الملف', 'error');
                }
            })
            .catch(error => {
                console.error('Error parsing Excel file:', error);
                showToast('خطأ', 'فشل في تحليل الملف', 'error');
            })
            .finally(() => {
                parseBtn.disabled = false;
                parseBtn.innerHTML = '<i class="bi bi-file-earmark-spreadsheet"></i> تحليل الملف';
            });
        }
        
        // Send bulk messages
        function sendBulkMessages() {
            const sessionId = sessionSelectBulk.value;
            const messageText = document.getElementById('bulk-message-text').value.trim();
            
            if (!sessionId || !messageText || extractedNumbers.length === 0) {
                showToast('خطأ', 'يرجى ملء جميع الحقول واستخراج الأرقام أولاً', 'error');
                return;
            }
            
            if (!confirm(`هل أنت متأكد من إرسال رسالة إلى ${extractedNumbers.length} رقم؟`)) {
                return;
            }
            
            const sendBtn = document.getElementById('send-bulk-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading-spinner"></span> جاري الإرسال...';
            
            // Show progress card
            progressCard.classList.remove('d-none');
            document.getElementById('total-count').textContent = extractedNumbers.length;
            
            fetch(`${API_BASE_URL}/api/bulk/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId,
                    numbers: extractedNumbers,
                    message: messageText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'accepted') {
                    showToast('نجاح', `تم إضافة ${extractedNumbers.length} رسالة إلى قائمة الانتظار`, 'success');
                    addActivity(`تم بدء إرسال ${extractedNumbers.length} رسالة بالجملة`);
                    
                    // Monitor progress
                    monitorBulkProgress(sessionId);
                } else {
                    showToast('خطأ', data.error || 'فشل في إرسال الرسائل', 'error');
                    progressCard.classList.add('d-none');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="bi bi-send"></i> إرسال للجميع';
                }
            })
            .catch(error => {
                console.error('Error sending bulk messages:', error);
                showToast('خطأ', 'فشل في إرسال الرسائل', 'error');
                progressCard.classList.add('d-none');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="bi bi-send"></i> إرسال للجميع';
            });
        }
        
        // Monitor bulk message progress
        function monitorBulkProgress(sessionId) {
            const progressBar = document.querySelector('.progress-bar');
            const sentCount = document.getElementById('sent-count');
            const totalCount = parseInt(document.getElementById('total-count').textContent);
            
            function checkProgress() {
                fetch(`${API_BASE_URL}/api/sessions/${sessionId}/queue`)
                    .then(response => response.json())
                    .then(data => {
                        const sent = data.sent;
                        const remaining = data.total;
                        const progress = Math.round((sent / totalCount) * 100);
                        
                        sentCount.textContent = sent;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                        progressBar.setAttribute('aria-valuenow', progress);
                        
                        if (remaining === 0 && sent >= totalCount) {
                            // All messages sent
                            showToast('نجاح', 'تم إرسال جميع الرسائل بنجاح', 'success');
                            addActivity(`تم الانتهاء من إرسال ${totalCount} رسالة بالجملة`);
                            
                            // Reset UI
                            document.getElementById('send-bulk-btn').disabled = false;
                            document.getElementById('send-bulk-btn').innerHTML = '<i class="bi bi-send"></i> إرسال للجميع';
                            
                            // Update dashboard
                            loadSessions();
                            
                            return;
                        }
                        
                        // Continue checking
                        setTimeout(checkProgress, 2000);
                    })
                    .catch(error => {
                        console.error('Error checking progress:', error);
                        setTimeout(checkProgress, 5000);
                    });
            }
            
            // Start checking progress
            checkProgress();
        }
        
        // Save settings
        function saveSettings() {
            const delay = document.getElementById('delay-between-messages').value;
            const autoReconnect = document.getElementById('auto-reconnect').checked;
            
            // Save settings to localStorage
            localStorage.setItem('delay-between-messages', delay);
            localStorage.setItem('auto-reconnect', autoReconnect);
            
            showToast('نجاح', 'تم حفظ الإعدادات بنجاح', 'success');
        }
        
        // Update dashboard
        function updateDashboard() {
            loadSessions();
        }
        
        // Add activity to the activity list
        function addActivity(text) {
            const activityList = document.getElementById('activity-list');
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span>${text}</span>
                    <small class="text-muted">${timeString}</small>
                </div>
            `;
            
            // Add to the beginning of the list
            activityList.insertBefore(listItem, activityList.firstChild);
            
            // Limit to 10 activities
            if (activityList.children.length > 10) {
                activityList.removeChild(activityList.lastChild);
            }
        }
        
        // Show toast notification
        function showToast(title, message, type = 'success') {
            const toastElement = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set toast color based on type
            toastElement.className = 'toast';
            if (type === 'error') {
                toastElement.classList.add('bg-danger', 'text-white');
            } else if (type === 'success') {
                toastElement.classList.add('bg-success', 'text-white');
            } else {
                toastElement.classList.add('bg-info', 'text-white');
            }
            
            const toastInstance = bootstrap.Toast.getInstance(toastElement);
            if (toastInstance) {
                toastInstance.show();
            } else {
                const newToast = new bootstrap.Toast(toastElement);
                newToast.show();
            }
        }
        
        // Helper functions
        function getStatusClass(status) {
            switch (status) {
                case 'CONNECTED':
                    return 'status-connected';
                case 'DISCONNECTED':
                case 'LOGGED_OUT':
                    return 'status-disconnected';
                case 'WAITING_FOR_SCAN':
                case 'INITIALIZING':
                    return 'status-waiting';
                default:
                    return '';
            }
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'CONNECTED':
                    return 'متصل';
                case 'DISCONNECTED':
                    return 'غير متصل';
                case 'LOGGED_OUT':
                    return 'تم تسجيل الخروج';
                case 'WAITING_FOR_SCAN':
                    return 'في انتظار المسح';
                case 'INITIALIZING':
                    return 'جاري التهيئة';
                default:
                    return status;
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    </script>
</body>
</html>
